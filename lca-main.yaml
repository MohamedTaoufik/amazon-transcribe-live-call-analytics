# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License").
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
AWSTemplateFormatVersion: "2010-09-09"

Description: Amazon Transcribe Live Call Analytics - LCA (v0.3.0)

Parameters:

  CallAudioSource:
    Type: String
    Default: Demo Asterisk PBX Server
    AllowedValues:
      - Demo Asterisk PBX Server
      - Chime Voice Connector (SIPREC)
      - Genesys Cloud Audiohook Web Socket
      - Amazon Connect Contact Lens
    Description: >
      Choose whether to automatically install a demo Asterisk PBX server for easy standalone testing, a
      Chime Voice Connector to use for standards based SIPREC/NBR integration with your contact center,
      a Web Socket interface to use for Audiohook integration with your Genesys Cloud CX contact center, 
      or integrate with Amazon Connect Contact Lens.

  DemoSoftphoneAllowedCidr:
    Type: String
    AllowedPattern: "( *|([0-9]{1,3}.){3}[0-9]{1,3}(/([0-9]|[1-2][0-9]|3[0-2])))"
    Description: >
      Used only when CallAudioSource is set to 'Demo Asterisk PBX Server'
      CIDR block allowed by demo Asterisk server for soft phone registration.
      Example: '198.51.100.36/32'

  SiprecAllowedCidrList:
    Type: String
    # yamllint disable rule:line-length
    AllowedPattern: "( *|(([0-9]{1,3}.){3}[0-9]{1,3}(/([0-9]|[1-2][0-9]|3[0-2]))))(, *([0-9]{1,3}.){3}[0-9]{1,3}(/([0-9]|[1-2][0-9]|3[0-2])))*"
    # yamllint enable rule:line-length
    Description: >
      Used only when CallAudioSource is set to 'Chime Voice Connector (SIPREC)'.
      Comma delimited list of public CIDR blocks allowed by Chime Voice Connector for SIPREC source hosts. Mask of /27 to /32 is allowed.
      Example: '198.51.100.0/27, 203.0.113.128/27'
  
  ConnectInstanceArn:
    Type: String
    AllowedPattern: '^(|arn:aws:connect:.*)$'
    Description: > 
      Required when CallAudioSource is set to 'Amazon Connect Contact Lens'
      Amazon Connect instance ARN of working instance. Prerequisite: Agent queue and Real Time Contact Lens must be enabled.

  AgentAssistOption:
    Type: String
    Default: AWS QnABot with new Kendra Index (Developer Edition)
    AllowedValues:
      - Disabled
      - Bring your own LexV2 bot
      - AWS QnABot with existing Kendra Index
      - AWS QnABot with new Kendra Index (Developer Edition)
      - AWS QnABot with new Kendra Index (Enterprise Edition)
    Description: >
      Choose to enable optional Agent Assist capability, powered by a nested AWS QnABot stack, or your own LexV2 bot. 
      AWS QnABot uses Amazon Lex and Amazon Kendra to provide real time agent assist messages based on intents, slots,
      FAQs, and general search index that you configure using the included ContentDesigner UI.

  AgentAssistExistingKendraIndexId:
    Default: ''
    Type: String
    AllowedPattern: '^(|[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12})$'
    Description: >
      Used only when AgentAssistOption is set to 'AWS QnABot with existing Kendra Index'.
      Provide the index *id* (not name) of an existing Kendra index to be used for Agent Assist bot."

  AgentAssistExistingLexV2BotId:
    Default: ''
    Type: String
    AllowedPattern: '^(|[0-9a-zA-Z]{10})$'
    Description: >
      Used only when AgentAssistOption is set to 'Bring your own LexV2 bot'.
      Provide the Lex V2 *Bot Id* (not name) of an existing LexV2 bot to be used for Agent Assist."

  AgentAssistExistingLexV2BotAliasId:
    Default: ''
    Type: String
    AllowedPattern: '^(|[0-9a-zA-Z]{10})$'
    Description: >
      Used only when AgentAssistOption is set to 'Bring your own LexV2 bot'.
      Provide the Lex V2 *Bot Alias Id* (not name) of an existing LexV2 bot alias to be used for Agent Assist."

  S3BucketName:
    Type: String
    Description: >
      (Optional) Existing bucket where call recording files will be stored.
      Leave blank to automatically create new bucket.
    # yamllint disable rule:line-length
    AllowedPattern: '( *|(?=^.{3,63}$)(?!^(\d+\.)+\d+$)(^(([a-z0-9]|[a-z0-9][a-z0-9\-]*[a-z0-9])\.)*([a-z0-9]|[a-z0-9][a-z0-9\-]*[a-z0-9])$))'
    # yamllint enable rule:line-length

  AudioFilePrefix:
    Type: String
    Default: lca-audio-recordings/
    Description: The Amazon S3 prefix where the audio files will be saved (must end in "/")

  IsContentRedactionEnabled:
    Type: String
    Default: 'false'
    Description: >-
      Enable content redaction from Amazon Transcribe transcription output. This is only used when
      the 'en-US' language is selected in the TranscribeLanguageCode parameter.
    AllowedValues:
      - 'true'
      - 'false'

  TranscribeContentRedactionType:
    Type: String
    Default: PII
    Description: >-
      Type of content redaction from Amazon Transcribe transcription output
    AllowedValues:
      - PII

  TranscribeLanguageCode:
    Type: String
    Description: >-
      Language code to be used for Amazon Transcribe
    Default: en-US
    AllowedValues:
      - en-US
      - es-US
      - en-GB
      - fr-CA
      - fr-FR
      - en-AU
      - it-IT
      - de-DE
      - pt-BR
      - ja-JP
      - ko-KR
      - zh-CN

  TranscribePiiEntityTypes:
    Type: String
    Default: BANK_ACCOUNT_NUMBER,BANK_ROUTING,CREDIT_DEBIT_NUMBER,CREDIT_DEBIT_CVV,CREDIT_DEBIT_EXPIRY,PIN,EMAIL,ADDRESS,NAME,PHONE,SSN
    Description: >-
      Select the PII entity types you want to identify or redact. Remove the values that you don't want to redact from the default. DO NOT ADD CUSTOM VALUES HERE.

  CustomVocabularyName:
    Type: String
    Default: ''
    Description: >-
      The name of the vocabulary to use when processing the transcription job. Leave blank if no custom vocabulary to be used. If yes, the custom
      vocabulary must pre-exist in your account.

  IsSentimentAnalysisEnabled:
    Type: String
    Default: 'true'
    Description: >-
      Enable sentiment analysis using Amazon Comprehend
    AllowedValues:
      - 'true'
      - 'false'

  AdminEmail:
    Type: String
    Description: >-
      Email address of admin user (e.g. jdoe@example.com) used for the API and web UI.
      An initial temporary password will be automatically sent to this user via email.
    AllowedPattern: '^[\w.+-]+@([\w-]+\.)+[\w-]{2,6}$'

  AllowedSignUpEmailDomain:
    Type: String
    Default: ''
    Description: >-
      Email address domain (e.g. example.com) that is allowed to signin and signup using the web UI.
      If left empty, signup via the web UI is disabled and users will have to be created using
      Cognito.
    AllowedPattern: '^(|([\w-]+\.)+[\w-]{2,6})$'

  DemoAsteriskDownloadUrl:
    Type: String
    Default: https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-16-current.tar.gz
    Description: URL for Asterisk source distribution tar file download - see https://www.asterisk.org/

  DemoAsteriskAgentAudioURL:
    Type: String
    Default: https://raw.githubusercontent.com/aws-samples/amazon-transcribe-live-call-analytics/main/lca-chimevc-stack/demo-audio/agent.wav
    Description: URL for audio (agent.wav) file download for demo Asterisk server.

  CloudFrontPriceClass:
    Type: String
    Default: PriceClass_100
    Description: >-
      Specify the CloudFront price class. See https://aws.amazon.com/cloudfront/pricing/ for a
      description of each price class.
    AllowedValues:
      - PriceClass_100
      - PriceClass_200
      - PriceClass_All
    ConstraintDescription: >-
      Allowed Price Classes PriceClass_100 PriceClass_200 and PriceClass_All

  CloudFrontAllowedGeos:
    Type: String
    Default: ''
    Description: >-
      Specify a comma separated list of two letter country codes (uppercase ISO 3166-1) that are
      allowed to access the web user interface via CloudFront. For example: US,CA. Leave empty if
      you do not want geo restrictions to be applied.
    AllowedPattern: '^(|[A-Z]{2}(,[A-Z]{2})*)$'
    ConstraintDescription: >-
      Comma separated list of uppercase two letter country codes or empty

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Telephony Ingestion Options
        Parameters:
          - CallAudioSource
          - DemoSoftphoneAllowedCidr
          - SiprecAllowedCidrList
          - ConnectInstanceArn
      - Label:
          default: Agent Assist Options
        Parameters:
          - AgentAssistOption
          - AgentAssistExistingKendraIndexId
          - AgentAssistExistingLexV2BotId
          - AgentAssistExistingLexV2BotAliasId
      - Label:
          default: Web UI Authentication
        Parameters:
          - AdminEmail
          - AllowedSignUpEmailDomain
      - Label:
          default: Amazon S3 Configuration
        Parameters:
          - S3BucketName
          - AudioFilePrefix
      - Label:
          default: Amazon Transcribe Configuration
        Parameters:
          - IsContentRedactionEnabled
          - TranscribeLanguageCode
          - TranscribeContentRedactionType
          - TranscribePiiEntityTypes
          - CustomVocabularyName
      - Label:
          default: Amazon Comprehend Configuration
        Parameters:
          - IsSentimentAnalysisEnabled
      - Label:
          default: Download locations
        Parameters:
          - DemoAsteriskDownloadUrl
          - DemoAsteriskAgentAudioURL
      - Label:
          default: Amazon CloudFront Configuration
        Parameters:
          - CloudFrontPriceClass
          - CloudFrontAllowedGeos
    ParameterLabels:
      S3BucketName:
        default: Call Audio Recordings Bucket Name
      AudioFilePrefix:
        default: Audio File Prefix
      AdminEmail:
        default: Admin Email Address
      AllowedSignUpEmailDomain:
        default: Authorized Account Email Domain
      CallAudioSource:
        default: Call Audio Source
      DemoSoftphoneAllowedCidr:
        default: Allowed CIDR Block for Demo Softphone
      SiprecAllowedCidrList:
        default: Allowed CIDR List for Siprec Integration
      ConnectInstanceArn:
        default: Amazon Connect instance ARN (existing)
      AgentAssistOption:
        default: Enable Agent Assist
      AgentAssistExistingKendraIndexId:
        default: Agent Assist Kendra IndexId (existing)
      IsContentRedactionEnabled:
        default: Enable Content Redaction for Transcripts
      TranscribeLanguageCode:
        default: Language for Transcription
      TranscribeContentRedactionType:
        default: Content Redaction Type for Transcription
      TranscribePiiEntityTypes:
        default: Transcription PII Redaction Entity Types
      CustomVocabularyName:
        default: Transcription Custom Vocabulary Name
      DemoAsteriskDownloadUrl:
        default: Demo Asterisk Server Source Code Download URL
      DemoAsteriskAgentAudioURL:
        default: Demo Asterisk Server Agent WAV File Download URL
      IsSentimentAnalysisEnabled:
        default: Enable Sentiment Analysis using Amazon Comprehend
      CloudFrontPriceClass:
        default: CloudFront Price Class
      CloudFrontAllowedGeos:
        default: CloudFront Allowed Geographies

Conditions:
  ShouldInstallDemoAsteriskServer: !Equals [!Ref CallAudioSource, 'Demo Asterisk PBX Server']
  ShouldInstallChimeVCsiprec: !Equals [!Ref CallAudioSource, 'Chime Voice Connector (SIPREC)']
  ShouldInstallChimeVCStack: !Or [!Condition ShouldInstallDemoAsteriskServer, !Condition ShouldInstallChimeVCsiprec]
  ShouldInstallGenesysAudiohookStack: !Equals [!Ref CallAudioSource, 'Genesys Cloud Audiohook Web Socket']
  ShouldInstallConnectIntegrationStack: !Equals [!Ref CallAudioSource, 'Amazon Connect Contact Lens']
  ShouldEnableLexAgentAssist: !Not [!Equals [!Ref AgentAssistOption, 'Disabled']]
  ShouldBringYourOwnBot: !Equals [!Ref AgentAssistOption, 'Bring your own LexV2 bot']
  ShouldInstallAWSQnaBot: !And [!Condition ShouldEnableLexAgentAssist, !Not [!Condition ShouldBringYourOwnBot]]
  ShouldCreateKendraIndexDeveloperEdition: !Equals [!Ref AgentAssistOption, 'AWS QnABot with new Kendra Index (Developer Edition)']
  ShouldCreateKendraIndexEnterpriseEdition: !Equals [!Ref AgentAssistOption, 'AWS QnABot with new Kendra Index (Enterprise Edition)']
  ShouldCreateKendraIndex: !Or [!Condition ShouldCreateKendraIndexDeveloperEdition, !Condition ShouldCreateKendraIndexEnterpriseEdition]

Mappings:
  TranscribeToComprehendLanguage:
    en-US:
      Value: en
    es-US:
      Value: es
    en-GB:
      Value: en
    fr-CA:
      Value: fr
    fr-FR:
      Value: fr
    en-AU:
      Value: en
    it-IT:
      Value: it
    de-DE:
      Value: de
    pt-BR:
      Value: pt
    ja-JP:
      Value: ja
    ko-KR:
      Value: ko
    zh-CN:
      Value: zh

  TranscribeToLexLocaleId:
    en-US:
      Value: en_US
    es-US:
      Value: es_US
    en-GB:
      Value: en_GB
    fr-CA:
      Value: fr_CA
    fr-FR:
      Value: fr_FR
    en-AU:
      Value: en_AU
    it-IT:
      Value: it_IT
    de-DE:
      Value: de_DE
    pt-BR:
      Value: pt_BR
    ja-JP:
      Value: ja_JP
    ko-KR:
      Value: ko_KR
    zh-CN:
      Value: zh_CH

Resources:

  KENDRA:
    Type: AWS::CloudFormation::Stack
    Condition: ShouldCreateKendraIndex
    Properties:
      # yamllint disable rule:line-length
      TemplateURL: https://s3.<REGION_TOKEN>.amazonaws.com/<ARTIFACT_BUCKET_TOKEN>/<ARTIFACT_PREFIX_TOKEN>/lca-kendra-stack/template.yaml
      # yamllint enable rule:line-length
      Parameters:
        IndexName: !Join ['', [!Ref 'AWS::StackName', '-Index']]
        IndexEdition:
          !If
          - ShouldCreateKendraIndexDeveloperEdition
          - 'DEVELOPER_EDITION'
          - 'ENTERPRISE_EDITION'

  QNABOT:
    Type: AWS::CloudFormation::Stack
    Condition: ShouldInstallAWSQnaBot
    Properties:
      # yamllint disable rule:line-length
      TemplateURL: https://s3.<REGION_TOKEN>.amazonaws.com/<ARTIFACT_BUCKET_TOKEN>/<ARTIFACT_PREFIX_TOKEN>/aws-qnabot/templates/master.json
      # yamllint enable rule:line-length
      Parameters:
        Email: !Ref AdminEmail
        Username: "Admin"
        LexV2BotLocaleIds: !FindInMap [TranscribeToLexLocaleId, !Ref TranscribeLanguageCode, Value]
        BootstrapBucket: <ARTIFACT_BUCKET_TOKEN>
        BootstrapPrefix: <ARTIFACT_PREFIX_TOKEN>/aws-qnabot
        InstallLexResponseBots: "false"
  
  AISTACK:
    Type: AWS::CloudFormation::Stack
    Properties:
      # yamllint disable rule:line-length
      TemplateURL: https://s3.<REGION_TOKEN>.amazonaws.com/<ARTIFACT_BUCKET_TOKEN>/<ARTIFACT_PREFIX_TOKEN>/lca-ai-stack/<VERSION_TOKEN>/template.yaml
      # yamllint enable rule:line-length
      Parameters:
        CallAudioSource: !Ref CallAudioSource
        S3BucketName: !Ref S3BucketName
        AudioFilePrefix: !Ref AudioFilePrefix
        AdminEmail: !Ref AdminEmail
        AllowedSignUpEmailDomain: !Ref AllowedSignUpEmailDomain
        IsContentRedactionEnabled: !Ref IsContentRedactionEnabled
        TranscribeContentRedactionType: !Ref TranscribeContentRedactionType
        TranscribeLanguageCode: !Ref TranscribeLanguageCode
        TranscribePiiEntityTypes: !Ref TranscribePiiEntityTypes
        CustomVocabularyName: !Ref CustomVocabularyName
        ComprehendLanguageCode:
          !FindInMap [TranscribeToComprehendLanguage, !Ref TranscribeLanguageCode, Value]
        IsSentimentAnalysisEnabled: !Ref IsSentimentAnalysisEnabled
        CloudFrontPriceClass: !Ref CloudFrontPriceClass
        CloudFrontAllowedGeos: !Ref CloudFrontAllowedGeos
        IsLexAgentAssistEnabled: 
          !If
            - ShouldEnableLexAgentAssist
            - true
            - false
        LexAgentAssistLocaleId:
          !FindInMap [TranscribeToLexLocaleId, !Ref TranscribeLanguageCode, Value]

  AGENTASSISTSETUP:
    Type: AWS::CloudFormation::Stack
    Condition: ShouldEnableLexAgentAssist
    DependsOn: AISTACK
    Properties:
      # yamllint disable rule:line-length
      TemplateURL: https://s3.<REGION_TOKEN>.amazonaws.com/<ARTIFACT_BUCKET_TOKEN>/<ARTIFACT_PREFIX_TOKEN>/lca-agentassist-setup-stack/template.yaml
      # yamllint enable rule:line-length
      Parameters:
        LCAStackName: !Ref AWS::StackName
        AISTACK: !Ref AISTACK
        QNABOTSTACK:
          !If
            - ShouldInstallAWSQnaBot
            - !Ref QNABOT
            - ""
        KendraIndexId:
          !If
            - ShouldCreateKendraIndex
            - !GetAtt KENDRA.Outputs.KendraIndexId
            - !Ref AgentAssistExistingKendraIndexId
        LexAgentAssistBotId:
          !If
            - ShouldInstallAWSQnaBot
            - !GetAtt QNABOT.Outputs.LexV2BotId
            - !Ref AgentAssistExistingLexV2BotId         
        LexAgentAssistAliasId:
          !If
            - ShouldInstallAWSQnaBot
            - !GetAtt QNABOT.Outputs.LexV2BotAliasId
            - !Ref AgentAssistExistingLexV2BotId  
        QnaAgentAssistDemoJson: <ARTIFACT_BUCKET_TOKEN>/<ARTIFACT_PREFIX_TOKEN>/lca-agentassist-setup-stack/qna-aa-demo.jsonl
      
  CHIMEVCSTACK:
    Type: AWS::CloudFormation::Stack
    Condition: ShouldInstallChimeVCStack
    Properties:
      # yamllint disable rule:line-length
      TemplateURL: https://s3.<REGION_TOKEN>.amazonaws.com/<ARTIFACT_BUCKET_TOKEN>/<ARTIFACT_PREFIX_TOKEN>/lca-chimevc-stack/template.yaml
      # yamllint enable rule:line-length
      Parameters:
        InstallDemoAsteriskServer:
          !If
          - ShouldInstallDemoAsteriskServer
          - true
          - false
        DemoSoftphoneAllowedCidr: !Ref DemoSoftphoneAllowedCidr
        SiprecAllowedCidrList: !Ref SiprecAllowedCidrList
        DemoAsteriskDownloadUrl: !Ref DemoAsteriskDownloadUrl
        DemoAsteriskAgentAudioURL: !Ref DemoAsteriskAgentAudioURL

  GENESYSAUDIOHOOKSTACK:
    Type: AWS::CloudFormation::Stack
    Condition: ShouldInstallGenesysAudiohookStack
    Properties:
      # yamllint disable rule:line-length
      TemplateURL: https://s3.<REGION_TOKEN>.amazonaws.com/<ARTIFACT_BUCKET_TOKEN>/<ARTIFACT_PREFIX_TOKEN>/lca-genesys-audiohook-stack/<VERSION_TOKEN>/template.yaml
      # yamllint enable rule:line-length
      Parameters:
        S3BucketName: !Ref S3BucketName
        AudioFilePrefix: !Ref AudioFilePrefix
        CallDataStreamName: !GetAtt AISTACK.Outputs.CallDataStreamName
        CloudFrontPriceClass: !Ref CloudFrontPriceClass
        IsContentRedactionEnabled: !Ref IsContentRedactionEnabled
        TranscribeContentRedactionType: !Ref TranscribeContentRedactionType
        TranscribeLanguageCode: !Ref TranscribeLanguageCode
        TranscribePiiEntityTypes: !Ref TranscribePiiEntityTypes
        CustomVocabularyName: !Ref CustomVocabularyName

  CONNECTINTEGRATIONSTACK:
    Type: AWS::CloudFormation::Stack
    Condition: ShouldInstallConnectIntegrationStack
    Properties:
      # yamllint disable rule:line-length
      TemplateURL: https://s3.<REGION_TOKEN>.amazonaws.com/<ARTIFACT_BUCKET_TOKEN>/<ARTIFACT_PREFIX_TOKEN>/lca-connect-integration-stack/template.yaml
      # yamllint enable rule:line-length
      Parameters:
        CallDataStreamArn: !GetAtt AISTACK.Outputs.CallDataStreamArn
        ConnectInstanceArn: !Ref ConnectInstanceArn

Outputs:

  ApplicationCloudfrontEndpoint:
    Description: LCA User Interface URL
    Value: !GetAtt AISTACK.Outputs.CloudfrontEndpoint

  AsteriskInstanceId:
    Description: Demo Asterisk Server EC2 instanceId
    Value:
      !If
      - ShouldInstallChimeVCStack
      - !GetAtt CHIMEVCSTACK.Outputs.AsteriskInstanceId
      - "Demo Asterisk PBX not enabled"

  DemoPBXIPAddress:
    Description: Demo Asterisk Server IP Address
    Value:
      !If
      - ShouldInstallChimeVCStack
      - !GetAtt CHIMEVCSTACK.Outputs.DemoPBXIPAddress
      - "Demo Asterisk PBX not enabled"

  DemoPBXPhoneNumber:
    Description: Demo Asterisk Server Phone Number
    Value:
      !If
      - ShouldInstallChimeVCStack
      - !GetAtt CHIMEVCSTACK.Outputs.DemoPBXPhoneNumber
      - "Demo Asterisk PBX not enabled"

  WebSocketEndpoint:
    Description: Websocket endpoint for Genesys Cloud Audiohook integration
    Value:
      !If
      - ShouldInstallGenesysAudiohookStack
      - !GetAtt GENESYSAUDIOHOOKSTACK.Outputs.WebSocketEndpoint
      - "Genesys Cloud Audiohook Web Socket not enabled"

  WebSocketAPIKey:
    Value:
      !If
      - ShouldInstallGenesysAudiohookStack
      - !GetAtt GENESYSAUDIOHOOKSTACK.Outputs.AudiohookAPIKey
      - "Genesys Cloud Audiohook Web Socket not enabled"

  WebSocketAPIClientSecret:
    Value:
      !If
      - ShouldInstallGenesysAudiohookStack
      - !GetAtt GENESYSAUDIOHOOKSTACK.Outputs.AudiohookAPIClientSecret
      - "Genesys Cloud Audiohook Web Socket not enabled"

  QnaBotContentDesigner:
    Description: Agent Assist Content Designer URL (AWS QnABot)
    Value: 
      !If
      - ShouldInstallAWSQnaBot
      - !GetAtt QNABOT.Outputs.ContentDesignerURL
      - "Agent Assist AWS QnABot not enabled"    
    
  RecordingsS3Bucket:
    Description: Bucket contains all the call recordings
    Value: !GetAtt AISTACK.Outputs.S3BucketName
  


